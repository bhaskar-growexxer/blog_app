<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PHP WebSocket Chat</title>

    <!-- Bootstrap CDN -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />

    <style>
        body {
            background: #f5f5f5;
        }
        #chatBox {
            height: 400px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .message {
            padding: 6px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .me {
            background: #d1e7dd;
            text-align: right;
        }
        .other {
            background: #e2e3e5;
        }
        .system {
            text-align: center;
            color: #777;
            font-style: italic;
        }
    </style>
</head>
<body class="p-4">

<div class="container">

    <h3 class="mb-4 text-center">Real-Time Chat (PHP WebSockets)</h3>

    <!-- ROOM + NAME MODAL -->
    <div class="modal show" id="joinModal" tabindex="-1" style="display:block; background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Join Chat</h5>
                </div>

                <div class="modal-body">

                    <label class="form-label">Your Name</label>
                    <input type="text" id="userName" class="form-control" />

                    <hr>

                    <div class="d-flex justify-content-between">
                        <button class="btn btn-success" onclick="createRoom()">Create Room</button>
                        <button class="btn btn-primary" onclick="showJoinRoom()">Join Room</button>
                    </div>

                    <div id="joinRoomBox" class="mt-3 d-none">
                        <label class="form-label">Enter Room ID</label>
                        <input type="text" id="roomIdInput" class="form-control" />
                        <button class="btn btn-primary mt-2" onclick="joinExistingRoom()">Join</button>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- ROOM DISPLAY -->
    <div id="roomInfo" class="alert alert-info d-none"></div>

    <!-- CHAT BOX -->
    <div id="chatBox"></div>

    <!-- SEND MESSAGE -->
    <div class="input-group mt-3">
        <input id="messageInput" class="form-control" placeholder="Type message..." />
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>

</div>


<script>
let socket;
let userName = null;
let roomId = null;

function randomRoomId() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

function showJoinRoom() {
    document.getElementById("joinRoomBox").classList.remove("d-none");
}

function connectWebSocket() {
    socket = new WebSocket("ws://localhost:9001");

    socket.onopen = () => {
        console.log("Connected ✅");

        socket.send(JSON.stringify({
            type: "join",
            name: userName,
            room: roomId
        }));

        document.getElementById("roomInfo").innerHTML =
            `✅ Joined Room: <b>${roomId}</b> as <b>${userName}</b>`;
        document.getElementById("roomInfo").classList.remove("d-none");
    };

    socket.onmessage = (event) => {
        let data = JSON.parse(event.data);
        let chatBox = document.getElementById("chatBox");

        if (data.type === "system") {
            chatBox.innerHTML += `<div class="system">${data.msg}</div>`;
        }

        if (data.type === "message") {
            chatBox.innerHTML += `
                <div class="message ${data.name === userName ? 'me' : 'other'}">
                    <b>${data.name}:</b> ${data.msg}
                </div>`;
        }

        chatBox.scrollTop = chatBox.scrollHeight;
    };

    socket.onerror = (err) => console.log("Socket Error:", err);
}

function createRoom() {
    userName = document.getElementById("userName").value.trim();

    if (!userName) return alert("Enter your name");

    roomId = randomRoomId();

    document.getElementById("joinModal").style.display = "none";

    connectWebSocket();
}

function joinExistingRoom() {
    userName = document.getElementById("userName").value.trim();
    roomId = document.getElementById("roomIdInput").value.trim();

    if (!userName) return alert("Enter your name");
    if (!roomId) return alert("Enter room ID");

    document.getElementById("joinModal").style.display = "none";

    connectWebSocket();
}

function sendMessage() {
    let text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    socket.send(JSON.stringify({
        type: "message",
        msg: text
    }));

    document.getElementById("messageInput").value = "";
}
</script>

</body>
</html>
